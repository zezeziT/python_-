
# Python 生成器详解

## 0. 前言
生成器（Generator）是 Python 中一种特殊的迭代器，能按需生成数据，不必一次性全部存储在内存中。
它们通过 `yield` 关键字实现，或者通过生成器表达式 `(expr for var in iterable)` 创建。

---

## 1. for 循环背后的运行机制

Python 的 `for x in iterable:` 大致等价于：

```python
iterator = iter(iterable)    # 调用 iterable.__iter__()
while True:
    try:
        item = next(iterator)  # 调用 iterator.__next__()
    except StopIteration:
        break
    print(item)  # 或者执行循环体
```

---

## 2. 例子 1：reverse 生成器

```python
def reverse(data):
    for i in range(len(data)-1, -1, -1):
        yield data[i]

for char in reverse('golf'):
    print(char)
```

### 运行步骤

1. `reverse('golf')` 创建生成器对象（函数体未运行）。
2. `for` 开始迭代，调用 `next()`，进入函数体。
3. `i=3` → yield 'f' → 暂停，返回 'f'。
4. `i=2` → yield 'l' → 暂停，返回 'l'。
5. `i=1` → yield 'o' → 暂停，返回 'o'。
6. `i=0` → yield 'g' → 暂停，返回 'g'。
7. range 耗尽，触发 StopIteration → 循环结束。

### 表格追踪

| 迭代 | i | yield 返回 | 打印 |
|---|---|---|---|
| 1 | 3 | 'f' | f |
| 2 | 2 | 'l' | l |
| 3 | 1 | 'o' | o |
| 4 | 0 | 'g' | g |
| 5 | — | StopIteration | — |

---

## 3. 例子 2：count_up_to

```python
def count_up_to(n):
    i = 1
    while i <= n:
        yield i
        i += 1

for num in count_up_to(5):
    print(num)
```

### 步骤

| 迭代 | i | yield 返回 | 更新后 i | 打印 |
|---|---|---|---|---|
| 1 | 1 | 1 | 2 | 1 |
| 2 | 2 | 2 | 3 | 2 |
| 3 | 3 | 3 | 4 | 3 |
| 4 | 4 | 4 | 5 | 4 |
| 5 | 5 | 5 | 6 | 5 |
| 6 | 6 | StopIteration | — | 循环结束 |

---

## 4. 例子 3：无限斐波那契

```python
def fibonacci():
    a, b = 0, 1
    while True:
        yield a
        a, b = b, a + b

fib_gen = fibonacci()
for _ in range(10):
    print(next(fib_gen))
```

### 步骤

| 次数 | yield 返回 (a) | 更新后 (a,b) |
|---|---|---|
| 1 | 0 | (1, 1) |
| 2 | 1 | (1, 2) |
| 3 | 1 | (2, 3) |
| 4 | 2 | (3, 5) |
| 5 | 3 | (5, 8) |
| 6 | 5 | (8, 13) |
| 7 | 8 | (13, 21) |
| 8 | 13 | (21, 34) |
| 9 | 21 | (34, 55) |
| 10 | 34 | (55, 89) |

---

## 5. 例子 4：生成器表达式

```python
squares = (x**2 for x in range(5))
for sq in squares:
    print(sq)
```

### 步骤

| 迭代 | x | yield 返回 | 打印 |
|---|---|---|---|
| 1 | 0 | 0 | 0 |
| 2 | 1 | 1 | 1 |
| 3 | 2 | 4 | 4 |
| 4 | 3 | 9 | 9 |
| 5 | 4 | 16 | 16 |
| 6 | — | StopIteration | 循环结束 |

---

## 6. 例子 5：过滤偶数

```python
def even_numbers(nums):
    for n in nums:
        if n % 2 == 0:
            yield n

for e in even_numbers(range(10)):
    print(e)
```

### 步骤

| n | 条件 n%2==0 | yield? | 打印 |
|---|---|---|---|
| 0 | True | yield 0 | 0 |
| 1 | False | — | — |
| 2 | True | yield 2 | 2 |
| 3 | False | — | — |
| 4 | True | yield 4 | 4 |
| 5 | False | — | — |
| 6 | True | yield 6 | 6 |
| 7 | False | — | — |
| 8 | True | yield 8 | 8 |
| 9 | False | — | — |

---

## 7. 例子 6：逐行读取大文件

```python
def read_file_line_by_line(filename):
    with open(filename, 'r', encoding='utf-8') as f:
        for line in f:
            yield line.strip()

for line in read_file_line_by_line('big_file.txt'):
    print(line)
```

### 步骤

1. 创建生成器对象 → 文件未打开。
2. 第一次 `next()`：进入 `with`，打开文件，读取第一行，yield 返回。
3. 继续 `next()`：恢复执行，读取下一行，yield 返回。
4. 文件读完 → `for line in f` 结束，退出 `with` → 文件关闭 → StopIteration。

---

## 8. sum(i*i for i in range(10))

```python
sum(i*i for i in range(10))
```

### 步骤（逐步求和）

- 0 + 1 + 4 + 9 + 16 + 25 + 36 + 49 + 64 + 81 = 285

---

## 9. 总结

1. 生成器创建时不执行，直到第一次 `next()` 才运行。
2. 每次 `yield` 会暂停函数，并返回一个值。
3. 下次迭代会从上次暂停点继续。
4. 当函数运行结束时会抛出 `StopIteration`，`for` 捕获后循环结束。
5. 生成器非常省内存，适合处理大数据或无限序列。

---

